#!/bin/bash

PG_USER="postgres"
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

# Проверяем наличие параметра с путем
if [ -z "$1" ]; then
    echo "Использование: $0 /путь/для/сохранения"
    exit 1
fi

OUTPUT_DIR="$1"

# Проверяем существование директории
if [ ! -d "$OUTPUT_DIR" ]; then
    mkdir -p "$OUTPUT_DIR"
fi

# Получаем список всех баз данных (исключая системные)
DATABASES=$(psql -U $PG_USER -t -c "SELECT datname FROM pg_database WHERE datistemplate = false AND datname != 'postgres';")

# Перебираем базы и экспортируем
for DB in $DATABASES; do
    DB_CLEAN=$(echo "$DB" | xargs)  # Убираем лишние пробелы
    if [ -n "$DB_CLEAN" ]; then
        echo "Экспорт базы: $DB_CLEAN"
        $SCRIPT_DIR/pg_export -u $PG_USER -d "$DB_CLEAN" -o "$OUTPUT_DIR"
    fi
done

echo "Экспорт завершен. Файлы сохранены в: $OUTPUT_DIR"